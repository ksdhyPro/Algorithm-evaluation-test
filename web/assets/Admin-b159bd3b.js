import{a as B,_ as Y,r as u,c as N,o as Z,b as ee,d as n,e as i,f as c,g as l,w as s,h as y,F as E,t as G,i as te,E as o,j as I,k as p}from"./index-d58af0fb.js";const L={getUsers(){return B.get("/api/users")},addUser(b){return B.post("/api/users/add",b)},deleteUser(b){return B.post("/api/users/delete",{id:b})}};const le={class:"admin-layout"},se={class:"admin-content"},ae={key:0,style:{display:"flex","align-items":"center",gap:"8px",color:"#000"}},ne={style:{"font-size":"12px"}},oe={key:1,style:{color:"#cfe8ff","font-size":"12px"}},re=30*1e3,de={__name:"Admin",setup(b){const m=u("user"),O=async t=>{if(t)try{const e=await L.deleteUser(t);e&&e.code===0?(o.success("删除成功"),A()):o.error(e.desc||"删除失败")}catch{o.error("删除用户失败")}},a=u({name:"",password:"",role:"user"}),F=u([]),h=u([]),x=u(null),_=u(null),w=u(0),v=u(!1);let g=null,f=null;const P=N(()=>_.value?(_.value/1024/1024/1024).toFixed(2)+" GB":"N/A"),$=N(()=>_.value==null||x.value==null||!v.value?"N/A":((_.value-x.value)/1024/1024/1024).toFixed(2)+" GB"),j=N(()=>{const t=Number(w.value||0);return t<=70?"#67C23A":t<=90?"#E6A23C":"#F56C6C"}),M=()=>{try{const t=localStorage.getItem("user");user.value=t?JSON.parse(t):null}catch{user.value=null}};window.addEventListener("auth-changed",M),Z(()=>{window.removeEventListener("auth-changed",M),f&&(document.removeEventListener("visibilitychange",f),f=null),g&&(clearInterval(g),g=null)});const A=async()=>{try{const t=await L.getUsers();t&&Array.isArray(t)&&(F.value=t)}catch{o.error("获取用户列表失败")}},H=async()=>{if(!a.value.name||!a.value.password||!a.value.role){o.error("请填写完整信息");return}try{const t=await L.addUser(a.value);t&&t.code===0?(o.success("添加成功"),a.value={name:"",password:"",role:"user"},A()):o.error(t.desc||"添加失败")}catch{o.error("添加用户失败")}},D=async()=>{try{const t=await I.getContests();Array.isArray(t)?h.value=t:t&&Array.isArray(t.data)&&(h.value=t.data)}catch{o.error("获取项目列表失败")}},J=async t=>{if(t)try{const e=await I.deleteContest(t);e&&e.code===0?(o.success("项目已删除"),D()):o.error(e.desc||"删除失败")}catch{o.error("删除项目失败")}},C=async()=>{try{const t=await I.getDiskInfo();if(t){const e=t;e.total_bytes!=null&&e.free_bytes!=null?(_.value=e.total_bytes,x.value=e.free_bytes,e.free_percent!=null?w.value=Math.round(100-Number(e.free_percent)):w.value=Math.round((e.total_bytes-e.free_bytes)/e.total_bytes*100),v.value=!0):v.value=!1}}catch{v.value=!1}};return ee(()=>{A(),D(),C(),g=setInterval(()=>{try{if(typeof document<"u"&&document.hidden)return}catch{}C()},re),f=()=>{try{document.hidden||C()}catch{}},document.addEventListener("visibilitychange",f)}),(t,e)=>{const U=n("el-menu-item"),R=n("el-menu"),S=n("el-input"),k=n("el-form-item"),T=n("el-option"),q=n("el-select"),V=n("el-button"),K=n("el-form"),Q=n("el-divider"),d=n("el-table-column"),z=n("el-table"),W=n("el-progress");return i(),c("div",le,[l(R,{class:"admin-menu","default-active":m.value,onSelect:e[0]||(e[0]=r=>m.value=r),style:{width:"200px","min-width":"200px"}},{default:s(()=>[l(U,{index:"user"},{default:s(()=>[...e[4]||(e[4]=[p("用户管理",-1)])]),_:1}),l(U,{index:"contest"},{default:s(()=>[...e[5]||(e[5]=[p("评测项目管理",-1)])]),_:1}),l(U,{index:"info"},{default:s(()=>[...e[6]||(e[6]=[p("服务器信息",-1)])]),_:1})]),_:1},8,["default-active"]),y("div",se,[m.value==="user"?(i(),c(E,{key:0},[e[9]||(e[9]=y("h2",null,"新增用户",-1)),l(K,{model:a.value,"label-width":"80px",style:{"max-width":"400px"}},{default:s(()=>[l(k,{label:"用户名"},{default:s(()=>[l(S,{modelValue:a.value.name,"onUpdate:modelValue":e[1]||(e[1]=r=>a.value.name=r),placeholder:"用户名"},null,8,["modelValue"])]),_:1}),l(k,{label:"密码"},{default:s(()=>[l(S,{modelValue:a.value.password,"onUpdate:modelValue":e[2]||(e[2]=r=>a.value.password=r),type:"password",placeholder:"密码"},null,8,["modelValue"])]),_:1}),l(k,{label:"角色"},{default:s(()=>[l(q,{modelValue:a.value.role,"onUpdate:modelValue":e[3]||(e[3]=r=>a.value.role=r),placeholder:"请选择角色"},{default:s(()=>[l(T,{label:"普通用户",value:"user"}),l(T,{label:"管理员",value:"admin"})]),_:1},8,["modelValue"])]),_:1}),l(k,null,{default:s(()=>[l(V,{type:"primary",onClick:H},{default:s(()=>[...e[7]||(e[7]=[p("添加用户",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),l(Q),e[10]||(e[10]=y("h3",null,"用户列表",-1)),l(z,{data:F.value,style:{width:"100%"}},{default:s(()=>[l(d,{prop:"id",label:"ID",width:"120"}),l(d,{prop:"name",label:"用户名"}),l(d,{prop:"role",label:"角色"}),l(d,{label:"操作",width:"100"},{default:s(r=>[l(V,{type:"danger",size:"small",onClick:X=>O(r.row.id)},{default:s(()=>[...e[8]||(e[8]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])],64)):m.value==="contest"?(i(),c(E,{key:1},[e[12]||(e[12]=y("h2",null,"评测项目管理",-1)),l(z,{data:h.value,style:{width:"100%"}},{default:s(()=>[l(d,{prop:"id",label:"项目ID",width:"180"}),l(d,{prop:"title",label:"标题"}),l(d,{prop:"owner_name",label:"主办方"}),l(d,{prop:"created_at",label:"创建时间"}),l(d,{label:"操作",width:"100"},{default:s(r=>[l(V,{type:"danger",size:"small",onClick:X=>J(r.row.id)},{default:s(()=>[...e[11]||(e[11]=[p("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])],64)):m.value==="info"?(i(),c(E,{key:2},[v.value?(i(),c("div",ae,[y("div",ne," 磁盘:已用: "+G($.value)+" / "+G(P.value),1),l(W,{percentage:Number(w.value),"stroke-width":10,color:j.value,style:{width:"160px"}},null,8,["percentage","color"])])):(i(),c("div",oe,"磁盘: N/A"))],64)):te("",!0)])])}}},ie=Y(de,[["__scopeId","data-v-66d87d11"]]);export{ie as default};
